<html>
  <head>
    <title>HarmonyStream</title>
  </head>
  <style>
    body {
      background-color: black;
      width: 100%;
      height: 100%;
      margin: 0px;
      display: flex;
      flex-direction: row;
      color: white;

      font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial,
        "Lucida Grande", sans-serif;
      font-weight: 300;
    }

    #player_id {
      margin: 0px;
      width: 80%;
      height: 100%;
    }

    #chat {
      margin: 0px;
      width: 20%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: scroll;
      background-color: rgb(20, 20, 20);
    }

    #chat #messagearea {
      margin: 5px;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      overflow: scroll;
    }

    input#messageinput {
      color: white;
      border: none;
      outline: none;
      background-color: rgb(60, 60, 60);
    }
  </style>
  <body>
    <video id="player_id" controls autoplay muted></video>
    <div id="chat">
      <h2 style="text-align: center">Chat</h2>
      <div id="messagearea">
        [chat feed start]
      </div>
      <div style="height: 30px">
        <input id="messageinput" type="text" name="message" style="width: 100%; height: 100%" />
      </div>
    </div>
  </body>

  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/3.2.0/dash.all.min.js"
    integrity="sha512-wFaKU7BcXbvVVGi0vDUKv4GXc9Hrp4RjGZorG8KlpRurhpvgCXiLhcafCj3y/gKY5CKAuyu00b+BvJ+vyRD0Pg=="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
    integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
    crossorigin="anonymous"
  ></script>
  <script src="./js/lib.js"></script>
  <script>
    const socket = io();
    let username = null;

    const url = "/live/app/manifest.mpd";
    const video = document.querySelector("video");
    const player = dashjs.MediaPlayer().create();
    player.initialize(video, url, true);
    player.updateSettings({
      streaming: {
        liveDelay: 1,
        liveCatchUpMinDrift: 0.05,
        liveCatchUpPlaybackRate: 0.5,
        stableBufferTime: 2,
        bufferTimeAtTopQuality: 2,
        bufferTimeAtTopQualityLongForm: 2,
        bufferToKeep: 2,
        bufferAheadToKeep: 2,
        lowLatencyEnabled: true,
        fastSwitchEnabled: true,
        abr: {
          limitBitrateByPortal: true,
        },
      },
    });

    const messageInput = document.getElementById("messageinput");
    messageInput.addEventListener("keyup", (event) => {
      if (event.key === "Enter") {
        if (messageInput.value.trim() === "") {
          return;
        }

        if (username === null || username.trim() === "") {
          username = prompt("Enter a username", "").trim();
          if (username === "" || username.length > 20) {
            alert("Invalid username (must be < 20 characters)");
            username = null;
            return;
          }
        }

        socket.emit("message", username, messageInput.value);
        messageInput.value = "";
      }
    });

    socket.on("connect", async () => {
      socket.on("message", (username, message) => {
        const elem = document.createElement("span");
        elem.innerHTML = `
          <span style="font-weight: bold;">${escapeHtml(username)}</span> ${escapeHtml(message)}
        `;
        const messageArea = document.getElementById("messagearea");
        messageArea.append(elem);
        messageArea.scrollTop = messageArea.scrollHeight;
      });
    });
  </script>
</html>
